<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>roar</title>
	
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		
		// TODO Add handling for the server being missing.
		var socket = io.connect("http://localhost:8080");
		
		
		socket.on('connect', function(data) {
			console.log("Connected to server.");
			
			
			if("roar-username" in localStorage) {
				// This client has logged in before. Present auth to the 
				// server.
				
				socket.emit("identify", {username:localStorage["roar-username"]});
				
				// Now we need to start listening for an identify response.
				socket.on('identify', _handleIdentityResponse);
			} else {
				// This client has not logged in before. Present the identify
				// UI and ask them what they want their name to be. Then
				// send that to the server. 
				$("#status-container").hide();
				$("#identity-container").show();
			}

			
		});
		
		
		// Should we defer listening for these messages until we're in 
		// totally logged-in state? 
		socket.on('chat.message', function (data) {
			
			if ("past" in data) {
				pastClass = " past";
			} else {
				pastClass = "";
			}
			
			messageHtml = "<div class='message" + pastClass + "'><span class='from'>" + data.from + "</span>:<span class='contents'>"+data.message+"</span></div>";
			
			appendToChat(messageHtml);
		});
		
		socket.on('admin.message', function(data) {
			messageHtml = "<div class='admin message'>" + data.message + "</div>";
			appendToChat(messageHtml);
		});
		
		$(document).ready( function() {
			
			
			$("#status-container").show();
			$("#identity-container").hide();
			$("#chat-container").hide();
			
			
			$("#chat").html("");
			$("#message").submit( function(event) {
				
				messageText = $("#message-text");
				
				// Stop if the message is empty.
				if(messageText.val() == "") {
					event.preventDefault();
					return;
				}
				
				socket.emit("chat.message", {message:messageText.val()});
				messageText.val("");
				event.preventDefault();
			});
			
			$("#set_name").click(function() {
				socket.emit("identify", {username:$("#name").val()});
				
				// Now we wait for the server to confirm it. 
				socket.on("identify", _handleIdentityResponse);
			});
			
		});
		
		
		function appendToChat(messageHtml) {
			chat = $("#chat");
			chat.html(chat.html() + messageHtml);
			
			// Scroll it to the bottom. 
			chat.scrollTop(chat.height());
		}
		
		function _handleIdentityResponse(data) {
			// this is called with repsonses to requests for a specific user
			// name. The server is either going to say "yes, you got it" or
			// "nope, that one is taken".
			if("state" in data && data["state"] == "OK") {
				// Start up the chat side of things.
				
				localStorage["roar-username"] = data["username"];
				
				$("#status-container").hide();
				$("#identity-container").hide();
				$("#chat-container").show();
				
			} else if ("state" in data && data["state"] == "TAKEN") {
				// Stay in the same mode.
				console.log("Taken username.");
			}
		}
		
	</script>
	<style type="text/css" media="screen">
		body {
			font-family: Helvetica, sans-serif;
		}
	
		.from {
			font-weight: bold;
			padding-left: 2px;
		}
		
		.message .contents {
			margin-left: 5px;
		}

		#container {
			width: 300px;
			border: 1px solid #bbb;
			margin-left: auto;
			margin-right: auto;
		}
		
		#chat-container {
			
		}
		
		#chat {
			width: 100%;
			height: 500px;
			overflow-y: scroll;
		}
		
		#message-text {
			width: 290px;
		}
		
		.message {
			float: left;
			width: 100%;
		}
		
		.past {
			color: #777;
		}
		
		#header {
			background-color: #FF2B2A;
			color: #ffffff;
			font-weight: bold;
			font-variant: small-caps;
			font-size: 1.2em;
			padding-left: 5px;
		}
		
		.admin {
			background-color: #ddd;
			text-align: center;
			border-bottom: 1px solid white;
		}
		

		
	</style>
</head>
<body id="index" onload="">

<div id="container">
<div id="header">
roar
</div>

<div id="status-container">
	<p>Connecting...</p>
</div>

<div id="identity-container">
<input type="text" name="name" value="your name?" id="name">
<input type="button" name="set_name" value="set name" id="set_name">
</div>

<div id="chat-container">
<div id="chat">
</div>
<form id="message"><input type="text" name="message" value="" id="message-text"></form>
</div>
</div>
</body>
